---
Title: URL外形監視をおこなう
Date: 2015-07-01T12:23:47+09:00
URL: https://mackerel.io/ja/docs/entry/external-monitoring
EditURL: https://blog.hatena.ne.jp/mackerelio/mackerelio-docs-ja.hatenablog.mackerel.io/atom/entry/8454420450099476443
---

本機能ではhttpまたはhttpsに対しての監視を行います。

## URL外形監視を設定する
画面左側メニューの監視ルールより「監視ルールを追加」のボタンをクリックします。「外形監視」をクリックすると以下の項目が表示されますので、各項目に値・名称を記述して作成ボタンをクリックします。

#### 監視対象

|設定項目|説明|
|-----|-----|
|HTTP メソッド|GET / POST / PUT / DELETE から選択できます。|
|URL|http または https を選択し、それ以後の URL を記述してください。|

#### 基本設定

|設定項目|説明|
|-----|-----|
|監視ルール名|本監視ルールの名前を記述してください。|
|監視ルールのメモ|記述したメモの内容はアラート一覧画面で検索できます。|

#### オプション

|設定項目|説明|
|-----|-----|
|レスポンスタイムが閾値より遅い場合にもアラートを発生させる|この外形監視ルールを任意のサービスに紐付け、そのサービスのサービスメトリックグラフとしてレスポンスタイムを可視化することができます。また、任意の閾値でレスポンスタイムの監視をすることもできます。<br>`Warning / Critical 条件`: 15 秒（15,000 ms）以上を指定された場合でも、15 秒応答がない場合はタイムアウトになります。<br>`平均値監視`: 過去 1 分 〜 10 分間の範囲で指定されたレスポンスタイムの平均値を監視します。|
|アラート発生までの最大試行回数|Warning / Critical のアラートに相当する異常が指定回数連続で発生した場合にアラートを発生させます。|
|通知の再送間隔|アラートの状態が指定された時間を超えても変化がない場合に再度通知します。|
|HTTP リクエストヘッダ|リクエストに任意の HTTP ヘッダを指定できます。`User-Agent` の指定がない場合は `User-Agent: mackerel-http-checker/x.y.z` が送信されます（x.y.z にはバージョン番号が入ります）。デフォルトで `Cache-Control` ヘッダに `no-cache` が指定されています。|
|リクエストボディ|リクエスト時のメッセージボディを指定します。|
|ステータスコードのチェック|ステータスコードが指定したコード以外の場合にアラートを発生させます。|
|レスポンスボディのチェック|レスポンスボディに指定の文字列が含まれているかをチェックします。指定された文字列がレスポンスボディに含まれていない場合にアラートを発生させます。|
|証明書の有効期限の監視|SSL証明書の有効期限を監視します。有効期限の残り日数が閾値を下回った場合にアラートを発生させます。|
|リクエスト時に証明書の確認を行わない|自己署名証明書を設置したサーバーを監視する際に、証明書の確認を行わずに監視を行うことができます。|
|レスポンスヘッダに従ってリダイレクトする|リダイレクト先のレスポンスを結果として評価します。|

## URL外形監視の仕様について
* チェック間隔は1分毎の固定となります。
* 次の条件でエラーと認識し、アラート通知が実行されます
    * ステータスコードが4xx系または5xx系の場合、またはステータスコードのチェック（オプション）で指定したコード以外の場合
    * タイムアウト(15秒)となった場合
    * SSL証明書が不正の場合
    * レスポンスタイムが閾値を超えている場合（オプション）
    * レスポンスボディに指定した文字列が含まれていない場合（オプション）
    * SSL証明書の有効期限の残り日数が閾値を下回っている場合（オプション）
* 2xx系の応答はエラーではない正常な応答として認識します
* リダイレクトのフォローに対する挙動は設定によって変更できます
  * フォローをしない場合、3xx系の応答はエラーではない正常な応答として認識します
  * フォローをする場合、レスポンスヘッダの内容に従ってリダイレクトを行います
    * 3回以上のリダイレクトはエラーとなり、アラート通知が実行されます
    * 監視対象 URL から cookie を受け取った場合（set-cookie）、リダイレクト先へは受け取った cookie 情報を含めてリクエストします
* Basic認証を利用しているURLを監視したい場合
  * HTTP リクエストヘッダ に Authorization ヘッダを指定する
    * `Name: Authorization`
    * `Value: Basic xxxxx`
      * `xxxxx` には `user:password`（認証情報の組み合わせ）を base64 形式でエンコードした文字列を記述します
  * 監視対象 URL を `https://user:password@example.com/` のように認証情報を含める形にする

## URL外形監視の監視元IPアドレスについて
Mackerelからの通知のリクエスト元IPアドレスレンジと同じとなります。  
詳細は[Webhook通知や外形監視など、Mackerelからの通知元IPアドレスは？](https://support.mackerel.io/hc/ja/articles/360039701332-Webhook%E9%80%9A%E7%9F%A5%E3%82%84%E5%A4%96%E5%BD%A2%E7%9B%A3%E8%A6%96%E3%81%AA%E3%81%A9-Mackerel%E3%81%8B%E3%82%89%E3%81%AE%E9%80%9A%E7%9F%A5%E5%85%83IP%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E3%81%AF-)をご覧下さい。

## 利用可能なプランについて
本機能はTrialプランまたは有料プランでのみご利用いただけます。

## 利用料金について
* アクティブなスタンダードホストが1台以上ある場合、監視ルール20個まで追加料金なしで利用可能です
* アクティブなスタンダードホストが0台の場合、監視ルール20個単位でスタンダードホスト1台分の料金が発生します
* 監視ルールが20個を超える場合、20個単位でスタンダードホスト1台分の追加料金が発生します

## アラートサンプル
監視ルールを追加するとサイドメニューにあるMonitorsの一覧に以下のように表示されます。
[https://cdn-ak.f.st-hatena.com/images/fotolife/m/mackerelio/20201109/20201109120423.png:image=https://cdn-ak.f.st-hatena.com/images/fotolife/m/mackerelio/20201109/20201109120423.png]

アラートが発生した際には以下の様な表示となり、アラート詳細画面で詳細が確認できます。  
画像上で表示されている503はHTTPステータスコードです。  
復旧した場合は復旧時のHTTPステータスコードが表示されるようになります。

[https://cdn-ak.f.st-hatena.com/images/fotolife/m/mackerelio/20150907/20150907154229.png:image=https://cdn-ak.f.st-hatena.com/images/fotolife/m/mackerelio/20150907/20150907154229.png]

[https://cdn-ak.f.st-hatena.com/images/fotolife/m/mackerelio/20150907/20150907154532.png:image=https://cdn-ak.f.st-hatena.com/images/fotolife/m/mackerelio/20150907/20150907154532.png]
